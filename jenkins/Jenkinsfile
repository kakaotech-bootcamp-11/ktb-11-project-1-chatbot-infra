pipeline {
    agent any
    environment {
        DOCKER_REPO = " {{ Docker.UserName }}/{{ registryName }}"
        GIT_BRANCH = '{{ git.branch }}'  // ë¹Œë“œí•  Git ë¸Œëœì¹˜
        JENKINS_NAMESPACE = '{{ jenkins.namesapce }}'  // kanikoë¡œ build í• ë•Œ ì‚¬ìš©í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë³´í†µ jenkinsì™€ ê°™ì€ namespaceì—ì„œ í•¨
        KANIKO_POD_YAML = '/var/jenkins_home/kaniko/kaniko-ci.yaml' // Kaniko Pod YAML íŒŒì¼ ê²½ë¡œ
        // KANIKO_POD_YAML NFS.dir path ìƒì„±í›„ì— ê·¸ ì•ˆì— Kaniko-ci.yamlì„ ë„£ì–´ì¤˜ì•¼ í•¨
        KANIKO_POD_NAME = '{{ kaniko.pod.NAME }}'
        DEPLOYMENT_NAMESPACE = ' {{deployment.namespace}} '
        DEPLOYMENT_NAME = ' {{ deployment.name }} '
        DEPLOYMENT_CONTAINER_NAME = '{{ deployment.container.name }}'
        }
    stages {
            stage('Checkout Source Code') {
                steps {
                    // Git ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                    checkout scm
                    script {
                        env.GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                        echo "Current Git Commit Short: ${env.GIT_COMMIT_SHORT}" // Git ì»¤ë°‹ IDì˜ ì• 7ìë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©

                        env.GIT_COMMIT_MESSAGE = sh(script: 'git log --no-merges -1 --pretty=%B', returnStdout: true).trim()
                        echo "Git Commit Message: ${env.GIT_COMMIT_MESSAGE}"
                    }
                }
            }
            stage('Update Kaniko YAML') {
                steps {
                    script {
                        // Kaniko YAML íŒŒì¼ì—ì„œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                        sh """
                        sed -i 's|--destination=.*|--destination=docker.io/${env.DOCKER_REPO}:${env.GIT_COMMIT_SHORT}",|' ${env.KANIKO_POD_YAML}
                        """
                    }
                }
            }
            stage('Deploy Kaniko Pod') {
                steps {
                    script {
                        // ê¸°ì¡´ Kaniko Pod ì‚­ì œ í›„ ìƒˆë¡œìš´ Kaniko Pod ë°°í¬
                        sh """
                        kubectl delete pod ${env.KANIKO_POD_NAME} -n ${env.JENKINS_NAMESPACE} --ignore-not-found
                        kubectl create -f ${env.KANIKO_POD_YAML} -n ${env.JENKINS_NAMESPACE}
                        """
                    }
                }
            }
            stage('Wait for Kaniko Build') {
                steps {
                    script {
                        // Kaniko Podê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                        timeout(time: 15, unit: 'MINUTES') {
                            waitUntil {
                                def status = sh(script: "kubectl get pod ${env.KANIKO_POD_NAME} -n ${env.JENKINS_NAMESPACE} -o jsonpath='{.status.phase}'", returnStdout: true).trim()
                                echo "Kaniko Pod Status: ${status}"
                                return (status == 'Succeeded') || (status == 'Failed')
                            }
                        }
                        // ìµœì¢… ìƒíƒœ í™•ì¸
                        def finalStatus = sh(script: "kubectl get pod ${env.KANIKO_POD_NAME} -n ${env.JENKINS_NAMESPACE} -o jsonpath='{.status.phase}'", returnStdout: true).trim()
                        if (finalStatus != 'Succeeded') {
                            error "Kaniko build failed with status: ${finalStatus}"
                        }
                    }
                }
            }
            stage('Deploy to Kubernetes') {
                steps {
                    script {
                        // Kubernetesì— ì´ë¯¸ì§€ ë°°í¬
                        sh """
                        kubectl set image deployment/${env.DEPLOYMENT_NAME} \
                        -n ${env.DEPLOYMENT_NAMESPACE} ${env.DEPLOYMENT_CONTAINER_NAME}=docker.io/${env.DOCKER_REPO}:${env.GIT_COMMIT_SHORT}
                        kubectl rollout status deployment/${env.DEPLOYMENT_NAME} -n ${env.DEPLOYMENT_NAMESPACE}
                        """
                    }
                }
            }
        }
        post {
            success {
                echo 'Build and push successful!'
                withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
                    discordSend title: "ë¹Œë“œ ì„±ê³µ: ${env.JOB_NAME} ğŸ‰",
                                                                description: """
                                                                **ì»¤ë°‹ ë©”ì‹œì§€**: `${env.GIT_COMMIT_MESSAGE}`
                                                                **ì»¤ë°‹ ID**: `${env.GIT_COMMIT_SHORT}`
                                                                **ë¹Œë“œ ë²ˆí˜¸**: `#${env.BUILD_NUMBER}`
                                                                **ìƒíƒœ**: ğŸ‰ **ì„±ê³µ**
                                                                """,
                                                                webhookURL: DISCORD
                }
            }
            failure {
                echo 'Build or deployment failed. Check logs for details.'
                withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
                    discordSend title: " ë¹Œë“œ ì‹¤íŒ¨: ${env.JOB_NAME} ğŸ‘",
                                                                            description: """
                                                                            **ì»¤ë°‹ ë©”ì‹œì§€**: `${env.GIT_COMMIT_MESSAGE}`
                                                                            **ì»¤ë°‹ ID**: `${env.GIT_COMMIT_SHORT}`
                                                                            **ë¹Œë“œ ë²ˆí˜¸**: `#${env.BUILD_NUMBER}`
                                                                            **ìƒíƒœ**: ğŸ‘ **ì‹¤íŒ¨**
                                                                            """,
                                                                            webhookURL: DISCORD
                }
            }
        }
    }
