pipeline {
    agent any
    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    environment {
        DOCKER_REPO = "${DOCKER_USERNAME}/${REGISTRY_NAME}"
        GIT_BRANCH = "${env.BRANCH_NAME}"
        GIT_COMMIT_SHORT = ''
        GIT_COMMIT_MESSAGE = ''
        DEPLOYMENT_NAMESPACE = "${params.DEPLOYMENT_NAMESPACE}"
        DEPLOYMENT_NAME = "${params.DEPLOYMENT_NAME}"
        DEPLOYMENT_CONTAINER_NAME = "${params.DEPLOYMENT_CONTAINER_NAME}"
        KANIKO_POD_YAML = '/var/jenkins_home/kaniko/kaniko-ci.yaml' // Kaniko Pod YAML íŒŒì¼ ê²½ë¡œ
        KANIKO_POD_NAME = 'kaniko-build-pod'
        JENKINS_NAMESPACE = 'jenkins' // Kaniko Podë¥¼ ì‹¤í–‰í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    }
    parameters {
        string(name: 'DEPLOYMENT_NAMESPACE', defaultValue: 'default', description: 'ë°°í¬í•  Kubernetes ë„¤ì„ìŠ¤í˜ì´ìŠ¤')
        string(name: 'DEPLOYMENT_NAME', defaultValue: 'my-app', description: 'ë°°í¬í•  Deployment ì´ë¦„')
        string(name: 'DEPLOYMENT_CONTAINER_NAME', defaultValue: 'my-container', description: 'Deployment ë‚´ ì»¨í…Œì´ë„ˆ ì´ë¦„')
    }
    stages {
        stage('Checkout Source Code') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.GIT_COMMIT_MESSAGE = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    echo "Current Git Commit Short: ${env.GIT_COMMIT_SHORT}"
                    echo "Git Commit Message: ${env.GIT_COMMIT_MESSAGE}"
                }
            }
        }
        stage('Unit Tests') {
            steps {
                sh 'make test' // ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •)
            }
        }
        stage('Update Kaniko YAML') {
            steps {
                script {
                    // Kaniko YAML íŒŒì¼ì—ì„œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                    sh """
                    sed -i 's|--destination=.*|--destination=${DOCKER_REPO}:${GIT_COMMIT_SHORT}",|' ${KANIKO_POD_YAML}
                    """
                }
            }
        }
        stage('Deploy Kaniko Pod') {
            steps {
                script {
                    // ê¸°ì¡´ Kaniko Pod ì‚­ì œ í›„ ìƒˆë¡œìš´ Kaniko Pod ë°°í¬
                    sh """
                    kubectl delete pod ${KANIKO_POD_NAME} -n ${JENKINS_NAMESPACE} --ignore-not-found
                    kubectl create -f ${KANIKO_POD_YAML} -n ${JENKINS_NAMESPACE}
                    """
                }
            }
        }
        stage('Wait for Kaniko Build') {
            steps {
                script {
                    // Kaniko Podê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                    timeout(time: 15, unit: 'MINUTES') {
                        waitUntil {
                            def status = sh(script: "kubectl get pod ${KANIKO_POD_NAME} -n ${JENKINS_NAMESPACE} -o jsonpath='{.status.phase}'", returnStdout: true).trim()
                            echo "Kaniko Pod Status: ${status}"
                            return (status == 'Succeeded') || (status == 'Failed')
                        }
                    }
                    // ìµœì¢… ìƒíƒœ í™•ì¸
                    def finalStatus = sh(script: "kubectl get pod ${KANIKO_POD_NAME} -n ${JENKINS_NAMESPACE} -o jsonpath='{.status.phase}'", returnStdout: true).trim()
                    if (finalStatus != 'Succeeded') {
                        error "Kaniko build failed with status: ${finalStatus}"
                    }
                }
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    // Kubernetesì— ì´ë¯¸ì§€ ë°°í¬
                    sh """
                    kubectl set image deployment/${DEPLOYMENT_NAME} \
                    -n ${DEPLOYMENT_NAMESPACE} ${DEPLOYMENT_CONTAINER_NAME}=${DOCKER_REPO}:${GIT_COMMIT_SHORT}
                    kubectl rollout status deployment/${DEPLOYMENT_NAME} -n ${DEPLOYMENT_NAMESPACE}
                    """
                }
            }
        }
    }
    post {
        always {
            script {
                currentBuild.result = currentBuild.result ?: 'SUCCESS'
            }
            echo "Build Result: ${currentBuild.result}"
            withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
                discordSend title: "ë¹Œë“œ ê²°ê³¼: ${env.JOB_NAME}",
                            description: """
                            **ì»¤ë°‹ ë©”ì‹œì§€**: `${env.GIT_COMMIT_MESSAGE}`
                            **ì»¤ë°‹ ID**: `${env.GIT_COMMIT_SHORT}`
                            **ë¹Œë“œ ë²ˆí˜¸**: `#${env.BUILD_NUMBER}`
                            **ìƒíƒœ**: ${currentBuild.result == 'SUCCESS' ? 'ğŸ‰ **ì„±ê³µ**' : 'ğŸ‘ **ì‹¤íŒ¨**'}
                            """,
                            webhookURL: DISCORD
            }
        }
    }
}
